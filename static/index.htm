<html>

<head>
    <title>INFO4310 - Spotify Global</title>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <style>
        @font-face {
            font-family: spotifyHeader;
            src: url("fonts/Gotham-Bold.otf");
        }
        @font-face {
            font-family: spotifyNormal;
            src: url("fonts/Gotham-Light.otf");
        }
        #header{
            font-family: spotifyHeader;
            color: #535353;
        }
        #instructions{
            font-family: spotifyNormal;
            color: #535353;
        }
        #personalization{
            font-family: spotifyNormal;
            color: #535353;
        }
        
        
        #visualization{
            display: flex;
            text-align:left;
        }
        tr{
            word-break: break-all;
        }
        #song-table{
            width: 700;
        }
        #gmap{
            width:1600;
            height:2000;
        }
        body {
            background-color: #ebebdd;
        }

    </style>
</head>

<body>
    <div id="header">
        <h1>Spotify Global</h1>
        <p>Amy Huang (ach243), Jonna Chen (jc2627), Kate Liang (ksl67), Stephanie Zhang (swz8)</p>
    </div>
    <div id="instructions">

    </div>
    <div id="visualization">
        <svg id="world-map" height = 400 width = 700></svg>
        <div id = "instructions">
            <h3 id = "table-name">Please Select a Country</h3>
            <table id = "song-table">
                <thead id = "thead">
                    <tr>
                        <th>Rank</th>
                        <th>Title</th>
                        <th>Artist</th>
                    </tr>
                </thead>
                <tbody id = "tbody"></tbody>
            </table>
        </div>
    </div>

    <div id="personalization">
        <a href="/login">Login with Spotify</a> 
        <div>
            <button class="timeFilter" name="4 Weeks" type="submit" value="short_term">4 weeks</button>
            <button class="timeFilter" name="6 Months" type="submit" value="medium_term">6 months</button>
            <button class="timeFilter" name="All-Time" type="submit" value="long_term">All-Time</button>
        </div>
        <ol id="topTracks"></ol>
    </div>
    
    <script>
        var topTracks = []
        var userAudioFeatures = []

        '{% for track in data %}'
        var id = ""
        var name = ""
        var url = ""

        try{
            id =  JSON.parse('{{track["id"]|tojson|safe}}')
        } catch(e){
            id = '{{track["id"]|tojson|safe}}'
            console.log(e)
        }

        try{
            name = JSON.parse('{{track["name"]|tojson|safe}}')
        } catch(e){
            name = '{{track["name"]|tojson|safe}}'
            console.log(e)
        }

        try{
            url = JSON.parse('{{track["url"]|tojson|safe}}')
        } catch(e){
            url = '{{track["url"]|tojson|safe}}'
            console.log(e)
        }

        topTracks.push({"id": id, "name": name, "url": url})
        '{% endfor %}'

        var topTracksList = d3.select("#topTracks");

        for(let i = 0; i < topTracks.length; i++){
            if(topTracks[i]["url"].substring(0, 5) != "https"){
                break
            }
            (async() => {
                const res = Promise.resolve(fetchTopTracksAudio(topTracks))
                res.then(value => {
                    if(value != null){
                        userAudioFeatures = value;
                    }
                })
            })();
            topTracksList.append("li").text(topTracks[i]["name"])

        }

        d3.selectAll(".timeFilter").on("click", fetchUserTopSongs);

        document.getElementById("song-table").style.display = "none";
        const drawWorldMap = async () => {
            // Load data
            let world = await d3.json("countries.geojson");
            // Remove Greenland and Antarctica
            world.features = world.features.filter(d => d.properties.ISO_A3 != "GRL" && d.properties.ISO_A3 != "ATA");
            var viral50 = await d3.json('viral_50.json');
            var viral50_csv = await d3.csv('viral_50_csv.csv');

            console.log(viral50_csv);
            var hoverCountry;
            var selectedCountry;
            var selectedCountryData;
            var relevantSongs = viral50;

            const getRelevantSongs = () =>{
                let relevantSongs = [];
                let country = selectedCountryData.properties.ADMIN;
                console.log("country", country)
                viral50_csv.forEach(song => {
                    let region = song.region;
                    if (region === country){
                        relevantSongs.push(song)
                    }
                });
                console.log("relevantSongs", relevantSongs);
                return relevantSongs;
            }

            const defaultSongList = () =>{
                console.log("ran default");
                let country = selectedCountryData.properties.ADMIN;
                document.getElementById("table-name").innerHTML = "Please Select a Country";
                document.getElementById("song-table").style.display = "none";

            }
            
            const updateSongList = (relevantSongs) =>{
                console.log("ran update");
                let country = selectedCountryData.properties.ADMIN;
                const table = document.getElementById('song-table');
                const thead = document.getElementById('thead');
		        const tbody = document.getElementById('tbody');
                
		        for (let i = 0; i < relevantSongs.length; i++) {
			        const row = tbody.insertRow(i);
			        row.insertCell(0).textContent = relevantSongs[i].rank;
			        row.insertCell(1).textContent = relevantSongs[i].title;
			        row.insertCell(2).textContent = relevantSongs[i].artist;
		        }
                document.getElementById("table-name").innerHTML = "Viral 50 Songs for " + country;
                document.getElementById("song-table").style.display = "block";
            }

            // Draw map
            const mapSvg = d3.select("#world-map");
            const mapMargin = { top: 20, left: 20, right: 20, bottom: 20 };
            const mapWidth = mapSvg.attr("width") - mapMargin.left - mapMargin.right;
            const mapHeight = mapSvg.attr("height") - mapMargin.top - mapMargin.bottom;
            const viewport = mapSvg.append("g").attr("id", "gmap");

            const projection = d3.geoMercator().fitSize([mapWidth, mapHeight], world);
            const path = d3.geoPath().projection(projection);
            
            let countryPaths = viewport.selectAll("countries").data(world.features)
            .join("path")
            .style("fill", "#535353")
            .attr("class", "countries")
            .attr("d", path);

            countryPaths.on("click", function (e, d) {
                    if (selectedCountry == null) {
                        console.log("initialize")
                        selectedCountry = d3.select(this);
                        selectedCountry.style("fill", "#1db954");
                        selectedCountryData = d;
                        relevantSongs = getRelevantSongs()
                        updateSongList(relevantSongs);
                    } else if (selectedCountryData === d) {
                        console.log("pressed on the same -- deselect");
                        selectedCountry.style("fill", "#535353");
                        selectedCountry = null;
                        defaultSongList();
                    } else {
                        console.log("pressed on diff country");
                        selectedCountry.style("fill", "#535353");
                        selectedCountry = d3.select(this);
                        console.log("new selected country", selectedCountry);
                        selectedCountry.style("fill", "#1db954");
                        selectedCountryData = d;
                        let relevantSongs = getRelevantSongs()
                        console.log("relevantsongs", relevantSongs)
                        updateSongList(relevantSongs);
                    }
            }).on("mouseover", function (e, d) {
                hoverCountry = d3.select(this);
                hoverCountry.style("fill", "#1db954");
                hoverCountryData = d;
                let hcountry = hoverCountryData.properties.ADMIN;
                document.getElementById("table-name").innerHTML = "Do you want to compare music taste with "+ hcountry + "?";
            }).on("mouseout", function (e, d) {
                // console.log(selectedCountry == null);
                if (selectedCountry == null|| selectedCountryData.properties.ADMIN != d.properties.ADMIN){
                    d3.select(this).style("fill","#535353");
                    document.getElementById("table-name").innerHTML = "Please Select a Country";
                } else {
                    d3.select(this).style("fill","#1db954");
                }
            });
            
            viewport.append("path")
            .datum(world.features)
            .attr("class", "zips_outline")
            .style("stroke", "white")
            .attr("fill-opacity", 0.0)
            .style("stroke-width", 1)
            .attr("d", path);
        }

        const drawRadarPlot = async () => {
            // generate dummy data -> todo -> make api call to get these features
            // todo: currently there are 3 layers, one for each data point. for the final result, need to average 
            // these features across the user's top 50 songs or something like that 
            let data = []
            let features = ["popularity", "danceability", "energy", "duration", "explicit"]
            for (var i = 0; i < 3; i++){
                var point = {}
                // each feature will be a random number from 1-9
                features.forEach(f => point[f] = 1 + Math.random() * 8);
                data.push(point);
            }
            console.log(data);

            let radarPlot = d3.select("#radar-plot");
            let radarWidth = radarPlot.attr("width")
            let radarHeight = radarPlot.attr("height")
            let radialScale = d3.scaleLinear().domain([0, 10]).range([0, 250]) // todo: real domain is 0 - 1
            let ticks = [2, 4, 6, 8, 10] // todo: change to be increments of 0.2 -> 1.0

            radarPlot.selectAll("circle").data(ticks)
                     .join("circle")
                     .attr("cx", radarWidth / 2)
                     .attr("cy", radarHeight / 2)
                     .attr("fill", "none")
                     .attr("stroke", "#ccc")
                     .attr("r", d => radialScale(d))

            radarPlot.selectAll(".tickLabel").data(ticks)
                     .join("text")
                     .attr("class", "ticklabel")
                     .attr("x", radarWidth / 2 + 5)
                     .attr("y", d => radarHeight / 2 - radialScale(d))
                     .text(d => d.toString())

            const angleToCoordinate = (angle, value) => {
                let x = Math.cos(angle) * radialScale(value);
                let y = Math.sin(angle) * radialScale(value);
                return {"x": radarWidth / 2 + x, "y": radarHeight / 2 - y};
            }

            let featureData = features.map((f, i) => {
                let angle = (Math.PI / 2) + (2 * Math.PI * i / features.length)
                return {
                    "name": f,
                    "angle": angle,
                    "line_coord": angleToCoordinate(angle, 10),
                    "label_coord": angleToCoordinate(angle, 10.5)
                };
            });

            // drawing the axis lines
            radarPlot.selectAll("line").data(featureData)
                     .join("line")
                     .attr("x1", radarWidth / 2)
                     .attr("y1", radarHeight / 2)
                     .attr("x2", d => d.line_coord.x)
                     .attr("y2", d => d.line_coord.y)
                     .attr("stroke","black")

            // drawing the axis labels
            radarPlot.selectAll(".axisLabel").data(featureData)
                     .join("text")
                     .attr("class", "axisLabel")
                     .attr("x", d => d.label_coord.x)
                     .attr("y", d => d.label_coord.y)
                     .text(d => d.name)

            // plotting the data
            let line = d3.line().x(d => d.x).y(d => d.y);
            let colors = ["darkorange", "gray", "navy"];

            const getPathCoordinates = (dataPoint) => {
                let coordinates = [];
                for (var i = 0; i < features.length; i++) {
                    let featureName = features[i];
                    let angle = (Math.PI / 2) + (2 * Math.PI * i / features.length);
                    coordinates.push(angleToCoordinate(angle, dataPoint[featureName]))
                }
                return coordinates
            } 
            radarPlot.selectAll("path").data(data)
                     .join("path")
                     .datum(d => { console.log(d); console.log(getPathCoordinates(d)); return getPathCoordinates(d) })
                     .attr("d", line)
                     .attr("stroke-width", 3)
                     .attr("stroke", (_, i) => colors[i])
                     .attr("fill", (_, i) => colors[i])
                     .attr("stroke-opacity", 1)
                     .attr("opacity", 0.5)
        }

        async function fetchUserTopSongs() {
            term = this.value
            token = '{{access_token}}'

            let args = new URLSearchParams({
                time_range: term,
                limit: 50,
                offset: 0
            });

            const result = await fetch("https://api.spotify.com/v1/me/top/tracks?" + args, {
                method: "GET", headers: { Authorization: `Bearer ${token}` }
            }).then(response => 
                response.json().then(data => ({
                    data: data,
                    status: response.status
                })
            ).then(res => {
                if(res.status != 200){
                    return
                }
                tracks = res.data["items"]
                topTracks = []
                for(let i = 0; i < tracks.length; i++){
                    topTracks.push({"id": tracks[i]["id"], "name": tracks[i]["name"], "url": tracks[i]["external_urls"]["spotify"], "popularity": tracks[i]["popularity"]})
                }
            }));

            document.getElementById("topTracks").innerHTML = "";
            var topTracksList = d3.select("#topTracks");
            for(let i = 0; i < topTracks.length; i++){
                topTracksList.append("li").text(topTracks[i]["name"])
            }

            const res =  await Promise.resolve(fetchTopTracksAudio(topTracks))
            userAudioFeatures = res
        }


        async function fetchTopTracksAudio(topTracks){
            var ids = ""
            var token = '{{access_token}}'

            for(let i = 0; i < topTracks.length; i++){
                ids += topTracks[i]["id"] + ","
            }

            var args = new URLSearchParams({
                ids: ids,
            });

            var audioFeatures = []

            const result = await fetch("https://api.spotify.com/v1/audio-features?" + args, {
                method: "GET", headers: { Authorization: `Bearer ${token}` }
            }).then(response => 
                response.json().then(data => ({
                    data: data,
                    status: response.status
                })
            ).then(res => {
                if(res.status != 200){
                    return
                }

                tracks = res.data["audio_features"]
                for(let i = 0; i < tracks.length; i++){
                    var obj = {}
                    var track_id = topTracks[i]["id"]
                    obj[track_id] = {
                        "danceability": tracks[i]["danceability"], 
                        "energy": tracks[i]["energy"], 
                        "popularity": topTracks[i]["popularity"]
                    }
                    audioFeatures.push(obj)
                }
            }));

            return audioFeatures
        }

        drawWorldMap();
        drawRadarPlot();
    </script>
    
</body>

</html>